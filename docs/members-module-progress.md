# Members Module Progress

## Phase Checklist

- [x] Phase 1 – Backend foundations (models, migration, CRUD updates, seed)
- [x] Phase 2 – Backend bulk & file operations (avatars, import/export, audit feed)
- [x] Phase 3 – Frontend reskin & core features (dark mode, table, filters, import wizard)
- [x] Phase 4 – Member profile & audit experience
- [x] Phase 5 – QA & polish (tests, docs, optional enhancements)

## Current Notes

- _Status_: Phase 2 APIs remain stable. Static uploads mount under `/static`; avatar upload (with audit trail), CSV import/export (auto-creating households/tags/ministries), and member audit feed are verified. The startup guard now provisions `member_gender`, `member_marital_status`, and the ancillary spouse/child columns when migrations lag—eliminating the `baptismal_name`/child column crashes we hit during clerk logins. Demo seed includes `superadmin@example.com` (all roles) plus PR Admin, Registrar, Clerk, and Finance Admin personas. Priests endpoints (`GET /priests`, `POST /priests`) and children promotion tooling (`GET /children?eligible=…`, `POST /children/{id}/promote`) are live, with the daily APScheduler job gracefully degrading when the dependency is unavailable. `/members/meta` now uses a guarded distinct query (sorted client-side) so CORS preflights return 200s instead of the Postgres `ORDER BY`/`DISTINCT` error. Membership contributions are now enforced at 75 CAD unless a documented hardship exception (`LowIncome`, `Senior`, `Student`, `Other`) is selected; contribution currency is captured, and new `member_contribution_payments` history endpoints/seed data surface payment logs in the UI.
- _UX progress_: Members list now reflects the planned UX pass—quick filters (Active / Has children / Missing phone / New this month / Archived) persist to the URL, rows are fully clickable, and a per-row action menu exposes archive/export/father-confessor shortcuts. The new hover-animated quick-add button launches a floating required-fields modal, while the Actions dropdown now uses a motion popover so it stays open while moving toward Export/Import. Context menus render on an opaque popover so they no longer inherit the backdrop blur transparency, and archiving now prompts for confirmation to avoid accidental deletes. The bulk toolbar groups Assign Father Confessor / Set Household / Export Selected / Archive Selected, and export routes accept explicit `ids` for CSVs. The assign-father-confessor modal auto-prompts the inline “Create new” priest form when a search yields no hits, keeping the workflow in-app. Contribution workflows received a finance-friendly polish (exception selector, locked base amount, low-income badge) and the member detail page now shows a contributions timeline with inline payment capture for Finance/Admin roles. Permission-aware error handling is in place via the shared `ApiError` helper, and Payments now reuses the member directory via smart suggestions + deep-linked payment timelines per member; the member “Financial Activity” card now writes directly into the shared ledger (service type dropdown, payment method select, timeline button).
- _Duplicate safeguards_: The API exposes `/members/duplicates` (email/phone/name search) and member create/edit screens surface inline warnings; save operations now reject exact email/phone conflicts so clerks don’t accidentally create clone records.
- _Next action_: Shift focus to the next module (per master roadmap) now that the membership module’s QA pass and documentation are complete.
- _Testing_: Re-ran curl suite (export CSV, import CSV with duplicates, avatar upload, audit feed) post-guard fix on 2025-11-04; verified clerk/finance logins no longer break the list API locally. Local parity check via Vite build + Nginx proxy confirmed UI → `/api` wiring. Contribution endpoints (`GET/POST /members/{id}/contributions`) exercised in the demo UI using Finance/Admin roles. See `docs/qa-checklist.md` for the full Phase 5 test matrix and manual steps.
- _Data Ops_: Keep `uploads/avatars` writable; rerun `alembic upgrade head` + `PYTHONPATH=$(pwd) python -m app.scripts.seed_demo` if the demo DB falls behind. **Env note:** local dev uses Vite on `5173` talking to FastAPI on `127.0.0.1:8001` (`VITE_API_BASE=http://localhost:8001`), while staging/prod builds must set `VITE_API_BASE=/api` so nginx can proxy to the systemd-managed backend (`salitemihret-backend` → `127.0.0.1:8000`). Include that flag before `pnpm build`, then `rsync` `dist/` to `/var/www/salitemihret` and `systemctl reload nginx` to keep the SPA + API aligned.

Update this file after each phase with progress, blockers, and test results.
